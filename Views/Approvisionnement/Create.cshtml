@model GesAppro.Models.Approvisionnement

@{
    ViewData["Title"] = "Nouvel approvisionnement";
}

<div class="container mt-3">
    <h2>Nouvel approvisionnement</h2>
    <form asp-action="Create" method="post" id="approForm">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Date d'approvisionnement</label>
                    <input asp-for="Date" class="form-control" type="date" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Fournisseur</label>
                    <input asp-for="Fournisseur" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Statut</label>
                    <select asp-for="Statut" class="form-select">
                        <option value="Reçu">Reçu</option>
                        <option value="En attente">En attente</option>
                        <option value="Annulé">Annulé</option>
                    </select>
                </div>
                <!-- Référence générée côté serveur ; affichée en lecture seule (non modifiable) -->
                <div class="mb-3">
                    <label class="form-label">Référence</label>
                    <input asp-for="Reference" class="form-control" readonly />
                </div>
                <div class="mb-3">
                    <label class="form-label">Observations</label>
                    <textarea class="form-control" name="Observations" placeholder="Observations ou commentaires sur cet approvisionnement"></textarea>
                </div>
            </div>

            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Détails de l'approvisionnement</label>
                </div>
                <div class="card p-3 mb-2">
                    <div id="productsContainer">
                        <!-- product rows will be injected here -->
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-outline-primary" id="addProduct">+ Ajouter un autre article</button>
                        <div>
                            <strong>Total: </strong> <span id="totalAmount">0</span> FCFA
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <a class="btn btn-secondary" href="/">Annuler</a>
            <button type="submit" class="btn btn-primary">Enregistrer l'approvisionnement</button>
        </div>
    </form>

    <!-- Product template -->
    <template id="productTemplate">
        <div class="product-row row g-2 align-items-end mb-2">
            <div class="col-md-6">
                <label class="form-label">Article</label>
                <input type="text" class="form-control product-name" name="__NAME__.NomProduit" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Quantité</label>
                <input type="number" min="0" class="form-control product-qty" name="__NAME__.Quantite" value="1" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Prix unitaire (FCFA)</label>
                <input type="number" min="0" step="0.01" class="form-control product-price" name="__NAME__.PrixUnitaire" value="0" />
            </div>
            <div class="col-md-1 text-end">
                <button type="button" class="btn btn-sm btn-danger remove-product">X</button>
            </div>
        </div>
    </template>
</div>

<script>
    (function(){
        const container = document.getElementById('productsContainer');
        const tmpl = document.getElementById('productTemplate').innerHTML;
        const addBtn = document.getElementById('addProduct');
        const totalEl = document.getElementById('totalAmount');
        let index = 0;

        function renderRow(i){
            const html = tmpl.replace(/__NAME__/g, `Produits[${i}]`);
            const wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            const row = wrapper.firstElementChild;

            // attach events
            const qty = row.querySelector('.product-qty');
            const price = row.querySelector('.product-price');
            const remove = row.querySelector('.remove-product');

            function recalc(){
                updateTotal();
            }

            qty.addEventListener('input', recalc);
            price.addEventListener('input', recalc);
            remove.addEventListener('click', function(){
                row.remove();
                updateTotal();
                // reindex remaining inputs to keep model binding consistent
                reindex();
            });

            container.appendChild(row);
        }

        function reindex(){
            const rows = container.querySelectorAll('.product-row');
            rows.forEach((r, i) => {
                const nameInputs = r.querySelectorAll('input');
                nameInputs.forEach(inp => {
                    if(inp.name.includes('NomProduit')) inp.name = `Produits[${i}].NomProduit`;
                    if(inp.name.includes('Quantite')) inp.name = `Produits[${i}].Quantite`;
                    if(inp.name.includes('PrixUnitaire')) inp.name = `Produits[${i}].PrixUnitaire`;
                });
            });
        }

        function updateTotal(){
            let total = 0;
            const rows = container.querySelectorAll('.product-row');
            rows.forEach(r => {
                const q = parseFloat(r.querySelector('.product-qty').value) || 0;
                const p = parseFloat(r.querySelector('.product-price').value) || 0;
                total += q * p;
            });
            totalEl.textContent = total.toLocaleString();
        }

        addBtn.addEventListener('click', function(){
            renderRow(index++);
        });

        // initial row
        renderRow(index++);
        updateTotal();
    })();
</script>
